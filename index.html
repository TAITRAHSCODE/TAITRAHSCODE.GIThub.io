<!DOCTYPE html>
<html>
<head>
    <title>HS Code Data Loader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 前面的樣式保持不變 */
        .detail-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>HS Code 資料管理</h2>
        <div class="button-group">
            <button id="initBtn" class="btn" onclick="initApp()">檢查並載入資料</button>
            <button id="resetBtn" class="btn btn-danger" onclick="resetDatabase()">重設資料庫</button>
        </div>
        <div class="progress">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progress-text" class="progress-text"></div>
        <div id="status" class="status">請選擇操作</div>
        <div id="detail-status" class="detail-status"></div>
    </div>

    <script>
        // 常數定義部分保持不變
        const BATCH_SIZE = 1000; // 每批處理的數據量

        // 顯示詳細狀態
        const showDetailStatus = (message) => {
            document.getElementById('detail-status').textContent = message;
        };

        // 更新進度文字
        const updateProgressText = (current, total, operation) => {
            const percentage = Math.round((current / total) * 100);
            document.getElementById('progress-text').textContent = 
                `${operation}: ${current}/${total} (${percentage}%)`;
        };

        // 批次插入數據
        const insertDataBatch = async (data) => {
            const total = data.length;
            let processed = 0;

            for (let i = 0; i < total; i += BATCH_SIZE) {
                const batch = data.slice(i, i + BATCH_SIZE);
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    batch.forEach(item => {
                        item.length = item.Code.length;
                        store.put(item);
                    });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (e) => reject(e.target.error);
                });

                processed += batch.length;
                const progress = (processed / total) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                updateProgressText(processed, total, '正在寫入數據');
            }
        };

        // 重設資料庫
        const resetDatabase = async () => {
            if (!confirm('確定要重設資料庫嗎？這將刪除所有現有資料，包括收藏項目。')) {
                return;
            }

            disableButtons();
            try {
                // 刪除資料庫
                showStatus('正在刪除舊資料...', 'loading');
                showDetailStatus('清除舊資料中...');
                await deleteDatabase();
                document.getElementById('progressBar').style.width = '0%';

                // 重新初始化
                showStatus('正在重新初始化...', 'loading');
                showDetailStatus('建立新資料庫結構...');
                await initDB();

                // 載入新數據
                await loadAllFiles();
            } catch (error) {
                showStatus('重設錯誤：' + error.message, 'error');
                showDetailStatus(error.stack);
                enableButtons();
            }
        };

        // 載入所有JSON檔案
        const loadAllFiles = async () => {
            loadedFiles = 0;
            let allData = [];
            
            try {
                // 分階段載入文件
                for (const file of files) {
                    showStatus(`正在載入 ${file}...`, 'loading');
                    showDetailStatus(`正在讀取 ${file}`);
                    
                    const response = await fetch(file);
                    if (!response.ok) throw new Error(`無法載入 ${file}`);
                    
                    const data = await response.json();
                    allData = allData.concat(data);
                    
                    loadedFiles++;
                    const progress = (loadedFiles / files.length) * 50; // 前50%進度用於載入文件
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    updateProgressText(loadedFiles, files.length, '載入文件');
                }

                // 寫入數據
                showStatus('正在寫入數據...', 'loading');
                await insertDataBatch(allData);

                // 完成
                showStatus('資料載入完成，即將轉向搜尋頁面...', 'success');
                showDetailStatus('完成！');
                setTimeout(() => window.location.href = 'index_search.html', 1500);
            } catch (error) {
                showStatus('載入錯誤：' + error.message, 'error');
                showDetailStatus(error.stack);
                enableButtons();
            }
        };

        // 初始化資料庫（優化版）
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 2);
                
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    showDetailStatus('創建資料表結構...');
                    
                    if (!db.objectStoreNames.contains(storeName)) {
                        const store = db.createObjectStore(storeName, { keyPath: 'Code' });
                        store.createIndex('length', 'length', { unique: false });
                        showDetailStatus('已創建主資料表');
                    }
                    
                    if (!db.objectStoreNames.contains(favoriteStore)) {
                        db.createObjectStore(favoriteStore, { keyPath: 'Code' });
                        showDetailStatus('已創建收藏資料表');
                    }
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    showDetailStatus('資料庫連接成功');
                    resolve(db);
                };

                request.onerror = (e) => {
                    showDetailStatus('資料庫連接失敗');
                    reject(e.target.error);
                };
            });
        };

        // 其他輔助函數保持不變...
    </script>
</body>
</html>
